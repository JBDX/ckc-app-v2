<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Cookies Challenge</title>
    <!-- Liens CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/client/src/styles/style.css">
    <style>
        .team-block.selected { box-shadow: 0 0 0 4px var(--color-brand-brown-dark); transform: translateY(-5px); }
        #edit-form-container { display: none; }
        .team-block__logo img { max-width: 60px; max-height: 60px; border-radius: 50%; object-fit: cover; }
        .history-table th { background-color: var(--color-brand-brown-light); }
        .point-positive { color: #198754; font-weight: bold; }
        .point-negative { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container my-5">
        <header class="page-header d-flex justify-content-between align-items-center">
            <div class="page-header__actions">
                <a href="index.html" class="btn btn-secondary me-2"><i class="bi bi-house-fill"></i> ACCUEIL</a>
            </div>
            <div class="page-header__logo">
                 <img src="/client/src/components/v2006_54.png" alt="Logo Cookies Challenge" class="img-fluid" style="max-height: 80px;">
            </div>
            <div id="logout-container" style="min-width: 140px; text-align: right;"></div>
        </header>

        <main>
            <h2 class="section-title text-center d-inline-block">GÉRER LES ÉQUIPES</h2>
            <p class="text-center text-muted mb-4">Cliquez sur une équipe pour la modifier.</p>
            <div id="teams-grid" class="row g-4 mb-5"></div>
            
            <!-- ===== FORMULAIRE DE MODIFICATION (QUI MANQUAIT) ===== -->
            <div id="edit-form-container" class="mb-5">
                <div class="card shadow-sm" style="border-radius: var(--border-radius-card);">
                    <div class="card-body p-4">
                        <h3 class="fw-bold mb-4">Modifier l'équipe : <span id="selected-team-name" class="text-capitalize"></span></h3>
                        <form id="edit-form" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="logo-input" class="form-label fw-bold">Changer le logo (PNG, JPG)</label>
                                <input type="file" class="form-control" id="logo-input" name="logoFile" accept="image/png, image/jpeg">
                            </div>
                            <div class="mb-4">
                                <label for="members-input" class="form-label fw-bold">Membres (séparés par une virgule)</label>
                                <textarea class="form-control" id="members-input" name="members" rows="3"></textarea>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="submit" class="btn btn-primary">Sauvegarder</button>
                                <button type="button" id="reset-score-btn" class="btn btn-danger">Points à Zéro</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ===== SECTION HISTORIQUE ===== -->
            <section id="history-section" class="mt-5">
                <div class="text-center">
                    <h2 class="section-title">HISTORIQUE DES ACTIONS</h2>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Professeur</th>
                                <th>Équipe</th>
                                <th class="text-center">Points</th>
                                <th>Raison</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <tr><td colspan="5" class="text-center text-muted">Chargement de l'historique...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Vérification du statut admin
    const token = localStorage.getItem('authToken');
    if (!token) { window.location.href = 'login.html'; return; }
    const currentUser = JSON.parse(atob(token.split('.')[1]));
    if (!currentUser.isAdmin) {
        alert("Accès refusé.");
        window.location.href = 'prof-home-page.html';
        return;
    }

    // Récupération des éléments du DOM
    const teamsGrid = document.getElementById('teams-grid');
    const editFormContainer = document.getElementById('edit-form-container');
    const editForm = document.getElementById('edit-form');
    const selectedTeamNameEl = document.getElementById('selected-team-name');
    const membersInput = document.getElementById('members-input');
    const logoInput = document.getElementById('logo-input');
    const resetScoreBtn = document.getElementById('reset-score-btn');
    const historyTableBody = document.getElementById('history-table-body');
    let allTeamsData = [];
    let selectedTeam = null;

    // Initialisation de la page
    function initializePage() {
        setupLogoutButton();
        fetchAndDisplayTeams();
        fetchAndDisplayHistory();
    }

    // Configuration du bouton de déconnexion
    function setupLogoutButton() {
        const logoutContainer = document.getElementById('logout-container');
        const logoutButton = document.createElement('button');
        logoutButton.className = 'btn btn-secondary';
        logoutButton.innerHTML = `<i class="bi bi-box-arrow-right"></i> DÉCONNEXION`;
        logoutButton.onclick = () => {
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        };
        logoutContainer.appendChild(logoutButton);
    }
    
    // Récupération et affichage des équipes
    async function fetchAndDisplayTeams() {
        try {
            const response = await fetch('/api/teams');
            allTeamsData = await response.json();
            teamsGrid.innerHTML = '';
            allTeamsData.forEach(team => {
                const teamColorClass = `team-block--${team.name.replace('s','')}`;
                const logoDisplay = `<img src="${team.logo}" alt="Logo ${team.name}">`;  
                const teamBlock = document.createElement('div');
                teamBlock.className = 'col-6 col-lg-3';
                teamBlock.innerHTML = `
                    <div class="team-block ${teamColorClass} h-100" data-team-name="${team.name}">
                        <div class="team-block__logo">${logoDisplay}</div>
                        <div class="team-block__points text-capitalize">${team.name}</div>
                    </div>`;
                teamsGrid.appendChild(teamBlock);
            });
        } catch (error) {
            teamsGrid.innerHTML = '<p class="text-danger">Impossible de charger les équipes.</p>';
        }
    }

    // Récupération et affichage de l'historique
    async function fetchAndDisplayHistory() {
        try {
            const response = await fetch('/api/teams/history/full');
            const history = await response.json();
            historyTableBody.innerHTML = '';
            if (history.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Aucune action enregistrée.</td></tr>';
                return;
            }
            history.forEach(item => {
                const date = new Date(item.created_at).toLocaleString('fr-FR');
                const pointsClass = item.points_change > 0 ? 'point-positive' : 'point-negative';
                const pointsSign = item.points_change > 0 ? '+' : '';
                const row = `
                    <tr>
                        <td>${date}</td>
                        <td>${item.prof_username}</td>
                        <td class="text-capitalize">${item.team_name}</td>
                        <td class="text-center ${pointsClass}">${pointsSign}${item.points_change}</td>
                        <td>${item.reason}</td>
                    </tr>`;
                historyTableBody.innerHTML += row;
            });
        } catch (error) {
            historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Impossible de charger l\'historique.</td></tr>';
        }
    }

    // Gestion du clic sur une équipe pour afficher le formulaire
    teamsGrid.addEventListener('click', (e) => {
        const teamBlock = e.target.closest('.team-block');
        if (!teamBlock) return;
        document.querySelectorAll('.team-block').forEach(b => b.classList.remove('selected'));
        teamBlock.classList.add('selected');
        selectedTeam = allTeamsData.find(t => t.name === teamBlock.dataset.teamName);
        if (selectedTeam) {
            selectedTeamNameEl.textContent = selectedTeam.name;
            membersInput.value = selectedTeam.members.join(', ');
            logoInput.value = '';
            editFormContainer.style.display = 'block';
        }
    });

    // Gestion de la soumission du formulaire de modification
    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedTeam) return;
        const formData = new FormData();
        formData.append('members', membersInput.value);
        if (logoInput.files[0]) {
            formData.append('logoFile', logoInput.files[0]);
        }
        try {
            const response = await fetch(`/api/admin/teams/${selectedTeam.name}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            if (!response.ok) throw new Error('La sauvegarde a échoué.');
            alert('Équipe mise à jour avec succès !');
            fetchAndDisplayTeams();
        } catch (error) {
            alert(error.message);
        }
    });

    // Gestion de la remise à zéro des points
    resetScoreBtn.addEventListener('click', async () => {
        if (!selectedTeam || !confirm(`Êtes-vous sûr de vouloir remettre les points de l'équipe "${selectedTeam.name}" à zéro ?`)) {
            return;
        }
        try {
            const response = await fetch(`/api/admin/teams/${selectedTeam.name}/reset-score`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('La remise à zéro a échoué.');
            alert('Points remis à zéro avec succès !');
            fetchAndDisplayTeams();
            fetchAndDisplayHistory();
        } catch (error) {
            alert(error.message);
        }
    });

    initializePage();
});
</script>

</body>
</html>