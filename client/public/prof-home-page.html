<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gérer les points - Cookies Challenge</title>
    <!-- Liens CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/client/src/styles/style.css">
    
    <!-- STYLES AJOUTÉS POUR CORRIGER L'AFFICHAGE DES LOGOS -->
    <style>
        .team-block.selected { box-shadow: 0 0 0 4px var(--color-brand-brown-dark); transform: translateY(-5px); }
        .form-container { display: none; }
        .team-block__logo img {
            max-width: 60px;
            max-height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>
<body>

    <div class="container my-5">
        <header class="page-header d-flex justify-content-between align-items-center">
             <div class="page-header__actions">
                <a href="index.html" class="btn btn-secondary me-2"><i class="bi bi-house-fill"></i> ACCUEIL</a>
            </div>
             <div class="page-header__logo">
                 <img src="/client/src/components/v2006_54.png" alt="Logo Cookies Challenge" class="img-fluid" style="max-height: 80px;">
            </div>
             <div id="logout-container" style="min-width: 140px; text-align: right;"></div>
        </header>

        <main>
            <h2 class="section-title text-center d-inline-block">GESTION DES POINTS</h2>
            <p class="text-center text-muted mb-4">Cliquez sur une équipe pour commencer.</p>
            <div id="teams-grid" class="row g-4 mb-5"></div>
            <div id="forms-container" class="form-container">
                <div class="card shadow-sm" style="border-radius: var(--border-radius-card);">
                    <div class="card-body p-4">
                        <h3 class="fw-bold mb-4">
                            Attribuer des points à l'équipe : <span id="selected-team-name-points" class="text-capitalize"></span>
                        </h3>
                        <form id="points-form">
                            <div class="d-flex justify-content-center gap-3 mb-3">
                                <select class="form-select btn btn-success" id="positive-actions"><option>Actions Positives</option></select>
                                <select class="form-select btn btn-danger" id="negative-actions"><option>Actions Négatives</option></select>
                            </div>
                            <div class="row">
                                <div class="col-md-3"><input type="text" id="points-display" class="form-control" placeholder="Points" readonly></div>
                                <div class="col-md-9"><input type="text" id="reason-display" class="form-control" placeholder="Raison" readonly></div>
                            </div>
                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-primary">VALIDER L'ACTION</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const positiveActions = [{"points":10,"reason":"aucun oubli sur une semaine"},{"points":10,"reason":"comportement positif sur une semaine"},{"points":10,"reason":"carnet à jour"},{"points":10,"reason":"écrire un message Arsène sans fautes d'orthographe"},{"points":50,"reason":"emprunter un livre au CDI"},{"points":50,"reason":"résolution de conflit"},{"points":50,"reason":"gagne un défi versus un enseignant"},{"points":50,"reason":"entraide entre élèves"},{"points":100,"reason":"effort sur le trimestre"}];
    const negativeActions = [{"points":-10,"reason":"écrire un message Arsène avec des fautes d'orthographe"},{"points":-50,"reason":"oubli (travail, livre, tenue)"},{"points":-50,"reason":"refuser d'essayer"},{"points":-50,"reason":"carnet non à jour"},{"points":-50,"reason":"perds le défi contre un enseignant"},{"points":-100,"reason":"comportement (insolence, attitude, etc)"},{"points":-100,"reason":"violence"}];
    const token = localStorage.getItem('authToken');
    if (!token) {
        window.location.href = 'login.html';
        return;
    }
    const currentUser = JSON.parse(atob(token.split('.')[1]));
    const teamsGrid = document.getElementById('teams-grid');
    const formsContainer = document.getElementById('forms-container');
    const pointsForm = document.getElementById('points-form');
    const posActionsSelect = document.getElementById('positive-actions');
    const negActionsSelect = document.getElementById('negative-actions');
    const pointsDisplay = document.getElementById('points-display');
    const reasonDisplay = document.getElementById('reason-display');
    let allTeamsData = [];
    let selectedTeam = null;

    function initializePage() {
        setupLogoutButton();
        populateActionDropdowns();
        fetchAndDisplayTeams();
    }

    function setupLogoutButton() {
        const logoutContainer = document.getElementById('logout-container');
        const logoutButton = document.createElement('button');
        logoutButton.className = 'btn btn-secondary';
        logoutButton.innerHTML = `<i class="bi bi-box-arrow-right"></i> DÉCONNEXION`;
        logoutButton.onclick = () => {
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        };
        logoutContainer.appendChild(logoutButton);
    }

    function populateActionDropdowns() {
        positiveActions.forEach(action => {
            const option = new Option(`${action.points} pts - ${action.reason}`, JSON.stringify(action));
            posActionsSelect.add(option);
        });
        negativeActions.forEach(action => {
            const option = new Option(`${action.points} pts - ${action.reason}`, JSON.stringify(action));
            negActionsSelect.add(option);
        });
    }

    async function fetchAndDisplayTeams() {
        try {
            const response = await fetch('http://localhost:3000/api/teams');
            allTeamsData = await response.json();
            teamsGrid.innerHTML = '';
            allTeamsData.forEach(team => {
                const teamColorClass = `team-block--${team.name.replace('s','')}`;
                // --- LA CORRECTION EST ICI ---
                // On utilise une balise <img> pour afficher le logo
                const logoDisplay = `<img src="http://localhost:3000${team.logo}" alt="Logo ${team.name}">`;
                
                const teamBlock = document.createElement('div');
                teamBlock.className = 'col-6 col-lg-3';
                teamBlock.innerHTML = `
                    <div class="team-block ${teamColorClass} h-100" data-team-name="${team.name}">
                        <div class="team-block__logo">${logoDisplay}</div>
                        <div class="team-block__points text-capitalize">${team.name}</div>
                    </div>`;
                teamsGrid.appendChild(teamBlock);
            });
        } catch (error) {
            teamsGrid.innerHTML = '<p class="text-danger">Impossible de charger les équipes.</p>';
        }
    }

    teamsGrid.addEventListener('click', (e) => {
        const teamBlock = e.target.closest('.team-block');
        if (!teamBlock) return;
        document.querySelectorAll('.team-block').forEach(b => b.classList.remove('selected'));
        teamBlock.classList.add('selected');
        const teamName = teamBlock.dataset.teamName;
        selectedTeam = allTeamsData.find(t => t.name === teamName);
        if (selectedTeam) {
            formsContainer.style.display = 'block';
            document.getElementById('selected-team-name-points').textContent = selectedTeam.name;
        }
    });

    posActionsSelect.addEventListener('change', (e) => {
        if (e.target.value === "Actions Positives") return;
        negActionsSelect.selectedIndex = 0;
        const action = JSON.parse(e.target.value);
        pointsDisplay.value = action.points;
        reasonDisplay.value = action.reason;
    });

    negActionsSelect.addEventListener('change', (e) => {
        if (e.target.value === "Actions Négatives") return;
        posActionsSelect.selectedIndex = 0;
        const action = JSON.parse(e.target.value);
        pointsDisplay.value = action.points;
        reasonDisplay.value = action.reason;
    });
    
    pointsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedTeam || !pointsDisplay.value) {
            alert("Veuillez sélectionner une équipe et une action.");
            return;
        }
        try {
            const response = await fetch('http://localhost:3000/api/teams/points', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    teamName: selectedTeam.name,
                    points: parseInt(pointsDisplay.value),
                    reason: reasonDisplay.value,
                    prof: currentUser.username
                })
            });
            if (!response.ok) throw new Error("Erreur lors de l'ajout des points.");
            alert('Points ajoutés avec succès !');
        } catch (error) {
            alert(error.message);
        }
    });

    initializePage();
});
</script>

</body>
</html>